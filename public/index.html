<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>$1 al mes ‚Äì Nada a cambio</title>
  <meta name="description" content="Paga $1 al mes y recibe absolutamente nada. Limitado a 1 mill√≥n de miembros." />
  <style>
    :root{
      --bg:#ffffff;        /* fondo */
      --fg:#000000;        /* texto */
      --muted:#6b7280;     /* gris sutil */
      --accent:#16a34a;    /* verde checks */
      --border:#e5e7eb;    /* borde suave */
      --alert:#dc2626;     /* rojo aviso */
      --stack-gap: clamp(16px, 3.2vw, 28px);
    }

    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
      font-family: Helvetica, Arial, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Liberation Sans", sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    *{box-sizing:border-box}

    /* Layout states */
    .screen{display:none;min-height:100dvh;padding:clamp(16px,4vw,40px)}
    .screen.active{display:flex;align-items:center;justify-content:center}

    /* SLOT SCREEN */
    .slot-wrap{width:min(1000px,92vw);display:flex;flex-direction:column;align-items:center;gap:clamp(16px,2.5vw,28px);text-align:center}
    .brand{font-weight:600;letter-spacing:.02em}
    .slots{display:grid;grid-template-columns:repeat(7,1fr);gap:clamp(6px,1.2vw,12px);width:100%;max-width:980px}
    .reel{position:relative;background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06);aspect-ratio:1/1.4;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .digit-window{font-variant-numeric:tabular-nums;font-feature-settings:"tnum" 1, "ss01" 1;font-size:clamp(48px,9vw,120px);line-height:1;font-weight:700}
    .slot-cta{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center}
    .btn{appearance:none;border:1px solid var(--fg);background:#000;color:#fff;padding:14px 20px;border-radius:999px;font-weight:600;cursor:pointer;transition:transform .06s ease,opacity .2s ease;letter-spacing:.01em}
    .btn:disabled{opacity:.4;cursor:not-allowed}
    .retry{margin-top:var(--stack-gap);}
    .linklike{appearance:none;background:transparent;border:none;padding:6px 10px;border-radius:999px;color:#111;font-weight:600;text-decoration:underline;cursor:pointer}
    .linklike:hover{opacity:.8}

    /* HOME SCREEN */
    .home-wrap{width:100%;max-width:min(860px,92vw);display:flex;flex-direction:column;gap:var(--stack-gap);align-items:center;text-align:center;justify-content:center;margin-left:auto;margin-right:auto}
    h1{margin:0;line-height:1.1;font-weight:700;font-size:clamp(28px,4.5vw,56px)}
    .sub{color:var(--muted);font-size:clamp(16px,2.2vw,20px)}
    .reservation{display:flex;flex-direction:column;gap:8px;align-items:center;padding:0;border:none;box-shadow:none;width:auto;max-width:none;background:transparent}
    .tag{display:inline-flex;align-items:center;gap:10px;font-variant-numeric:tabular-nums;font-weight:700;letter-spacing:.02em;padding:8px 14px;border-radius:999px;border:1px solid var(--border)}
    .countdown{font-weight:700}
    .actions{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
    .btn-black{background:#000;color:#fff}
    .btn-white{background:#fff;color:#000;border:1px solid var(--fg)}
    .checks{display:grid;grid-template-columns:1fr;gap:var(--stack-gap);width:100%;max-width:560px;justify-items:center;text-align:left}
    .check{display:flex;align-items:center;gap:10px;justify-content:flex-start;width:100%;max-width:560px}
    .check svg{flex:0 0 auto}
    .home-fold{min-height:100dvh;display:flex;align-items:center;justify-content:center;width:100%}
    .home-stack> * + *{margin-top:var(--stack-gap)}
    .home-stack{display:flex;flex-direction:column;align-items:center;padding-block:var(--stack-gap)}

    /* Subtle fade transitions */
    .fade-enter{opacity:0;transform:translateY(10px)}
    .fade-enter-active{opacity:1;transform:none;transition:all .5s ease}

    /* Staggered entrance (Apple-like) */
    @keyframes fadeUp { from { opacity:0; transform: translateY(8px); } to { opacity:1; transform:none; } }
    .stagger > *{opacity:0; transform: translateY(8px)}
    .stagger-on > *{animation: fadeUp .6s ease forwards}
    .stagger-on > *:nth-child(1){animation-delay:.00s}
    .stagger-on > *:nth-child(2){animation-delay:.08s}
    .stagger-on > *:nth-child(3){animation-delay:.16s}
    .stagger-on > *:nth-child(4){animation-delay:.24s}
    .stagger-on .home-stack > *{opacity:0;animation: fadeUp .6s ease forwards}
    .stagger-on .home-stack > *:nth-child(1){animation-delay:.20s}
    .stagger-on .home-stack > *:nth-child(2){animation-delay:.32s}
    .stagger-on .home-stack > *:nth-child(3){animation-delay:.44s}

    /* Expiration notice */
    .notice{position:fixed;top:12px;left:50%;transform:translateX(-50%);padding:10px 16px;border-radius:999px;border:1px solid rgba(220,38,38,.25);background:rgba(220,38,38,.08);color:var(--alert);font-weight:600;display:none;z-index:50}

    /* LOSER SCREEN */
    .loser-wrap{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px;background:#fff}
    .emoji-box{position:relative;display:inline-flex;align-items:center;justify-content:center}
    .emoji{font-size:clamp(160px,32vw,360px);display:inline-block;animation: headTilt 2.2s ease-in-out infinite, scalePulse 2.2s ease-in-out infinite}
    .back-link{appearance:none;background:transparent;border:1px solid #111;color:#111;padding:10px 14px;border-radius:999px;font-weight:600;cursor:pointer}

    @keyframes headTilt{ 0%,100%{ transform: rotate(0deg)} 25%{ transform: rotate(3deg)} 50%{ transform: rotate(0deg)} 75%{ transform: rotate(-3deg)} }
    @keyframes scalePulse{ 0%,100%{ transform: scale(1)} 50%{ transform: scale(1.06)} }
  </style>
  <style>
    /* Checkout & Auth modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55)}
    .modal.active{display:flex}
    .sheet{background:#fff;color:#000;width:min(520px,92vw);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.25);padding:24px;position:relative}
    .sheet h2{margin:0 0 12px 0;font-size:22px}
    .pay-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    .pay-btn{display:flex;align-items:center;justify-content:center;gap:10px;border:1px solid #111;border-radius:999px;padding:12px 16px;font-weight:600;cursor:pointer}
    .close-x{position:absolute;right:16px;top:12px;background:transparent;border:none;font-size:24px;cursor:pointer}
    .fine{color:#6b7280;font-size:13px;margin-top:12px}

    /* Inputs helpers */
    input:focus{outline:none;box-shadow:0 0 0 3px rgba(0,0,0,.08)}
  </style>
  <style>
    /* Header/logo */
    .app-header{position:fixed;top:14px;left:14px;z-index:100;display:flex;align-items:center;gap:10px}
    .site-logo-text{
      font-family: Helvetica, Arial, sans-serif;
      font-weight: 700;
      font-size: clamp(28px, 3vw, 40px);
      color:#111;
      letter-spacing:0;
      user-select:none;
    }
  </style>
</head>
<body>
  <!-- Header con logo fijo (texto) -->
  <header class="app-header" role="banner" aria-label="Marca VANO">
    <div class="site-logo-text">VANO</div>
  </header>
  <button id="expireNotice" class="notice" role="alert" aria-live="assertive">El tiempo se agot√≥, vuelve a intentarlo</button>

  <!-- SLOT MACHINE SCREEN -->
  <section id="slotScreen" class="screen active" aria-labelledby="slotTitle">
    <div class="slot-wrap">
      <div class="brand" aria-label="Marca premium">&nbsp;</div>
      <h1 id="slotTitle">Tu n√∫mero de miembro</h1>

      <!-- Teaser solicitado -->
      <p id="benefitsTeaser" class="fine" aria-live="polite" style="text-align:center;margin:-6px 0 4px;">
        Beneficios exclusivos pr√≥ximamente
      </p>

      <div class="slots" aria-live="polite" aria-atomic="true">
        <div class="reel"><div class="digit-window" data-reel="0">0</div></div>
        <div class="reel"><div class="digit-window" data-reel="1">0</div></div>
        <div class="reel"><div class="digit-window" data-reel="2">0</div></div>
        <div class="reel"><div class="digit-window" data-reel="3">0</div></div>
        <div class="reel"><div class="digit-window" data-reel="4">0</div></div>
        <div class="reel"><div class="digit-window" data-reel="5">0</div></div>
        <div class="reel"><div class="digit-window" data-reel="6">0</div></div>
      </div>

      <div class="slot-cta">
        <button id="spinBtn" class="btn" aria-describedby="probHint">Obtener mi n√∫mero</button>
      </div>
      <p style="margin:6px 0 0 0;font-size:14px;color:#111;">
        <button id="openLogin" class="linklike" aria-haspopup="dialog">Iniciar sesi√≥n</button>
      </p>
    </div>
  </section>

  <!-- HOME SCREEN -->
  <main id="homeScreen" class="screen" aria-labelledby="homeTitle">
    <div class="home-wrap home-fold">
      <div class="fade-enter stagger" id="homeInner">
        <h1 id="homeTitle">Paga $1 al mes y recibe absolutamente nada.</h1>
        <p class="sub">Limitado a solo 1 mill√≥n de miembros.</p>

        <div class="home-stack">
          <div class="reservation" role="status" aria-live="polite" aria-atomic="true">
            <div class="tag" id="memberTag" title="N√∫mero reservado por 45 segundos">
              N¬∫ <span id="memberNumber">‚Äî</span> ¬∑ <span>Reservado</span>
            </div>
            <div class="countdown">Expira en <span id="countdown">45</span>s</div>
          </div>

          <div class="actions">
            <button id="joinBtn" class="btn btn-black">Quiero unirme, soy incre√≠ble</button>
            <button id="loseBtn" class="btn btn-white">Soy un perdedor</button>
          </div>

          <div class="checks" aria-label="Condiciones">
            <div class="check">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M20 6L9 17l-5-5" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              <span>Cancela en cualquier momento</span>
            </div>
            <div class="check">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M20 6L9 17l-5-5" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              <span>1 dollar al mes</span>
            </div>
            <div class="check">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M20 6L9 17l-5-5" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              <span>S√© parte del 0,012% del planeta</span>
            </div>
          </div>

          <p class="retry"><button id="retryLink" class="linklike">Obtener nuevo n√∫mero</button></p>
        </div>
      </div>
    </div>
  </main>

  <!-- LOSER SCREEN -->
  <section id="loserScreen" class="screen" aria-labelledby="loserTitle">
    <div class="loser-wrap">
      <h1 id="loserTitle" style="position:absolute;left:-9999px;">Pantalla de broma</h1>
      <div class="emoji-box" aria-hidden="true">
        <span class="emoji">üòÇ</span>
      </div>
      <button id="backToMenu" class="back-link">Regresar al men√∫ principal</button>
    </div>
  </section>

  <!-- SUCCESS SCREEN -->
  <section id="successScreen" class="screen" aria-labelledby="successTitle">
    <canvas id="confetti" aria-hidden="true" style="position:fixed;inset:0;pointer-events:none"></canvas>
    <div class="home-wrap" style="gap:24px; text-align:center;">
      <h1 id="successTitle">¬°Bienvenido!</h1>
      <p class="sub">Tu n√∫mero de miembro</p>
      <div class="big-number" style="font-variant-numeric:tabular-nums;font-weight:800;font-size:clamp(40px,7vw,84px);">N¬∫ <span id="purchasedNumber">‚Äî</span></div>
      <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
        <button id="cancelSub" class="btn btn-white" style="border:1px solid #000;color:#000;background:#fff">Cancelar suscripci√≥n</button>
        <button id="termsLink" class="btn btn-black" style="background:#000;color:#fff">T√©rminos y condiciones</button>
      </div>

      <!-- Frase de beneficencia solicitada -->
      <p class="fine" style="margin-top:10px;">
        Los fondos recaudados ser√°n utilizados en beneficencia del pueblo ecuatoriano.
      </p>

      <div id="postCancelInfo" style="display:none; margin-top:12px">
        <p class="sub" id="releaseInfo">Tu n√∫mero se liberar√° el <span id="releaseDate">‚Äî</span>.</p>
        <button id="renewSub" class="btn btn-black">Renovar la suscripci√≥n</button>
      </div>
    </div>
  </section>

  <!-- CONFIRM CANCEL MODAL -->
  <div id="confirmCancel" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmCancelTitle">
    <div class="sheet">
      <button class="close-x" aria-label="Cerrar" id="confirmCancelClose">√ó</button>
      <h2 id="confirmCancelTitle">¬øCancelar suscripci√≥n?</h2>
      <p class="fine" style="font-size:14px;line-height:1.6">
        ¬øEst√°s seguro que deseas cancelar la suscripci√≥n? <strong>Tu n√∫mero de miembro volver√° a estar disponible</strong>
        cuando finalice tu ciclo actual de 28 d√≠as. Cualquier cobro futuro ser√° cancelado.
      </p>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
        <button id="confirmNo" class="btn btn-white" style="background:#fff;color:#000;border:1px solid #000">No</button>
        <button id="confirmYes" class="btn btn-black">S√≠</button>
      </div>
    </div>
  </div>

  <!-- TERMS MODAL -->
  <div id="termsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="termsTitle">
    <div class="sheet">
      <button class="close-x" aria-label="Cerrar" id="termsClose">√ó</button>
      <h2 id="termsTitle">T√©rminos y condiciones</h2>
      <div class="fine" style="font-size:14px;line-height:1.6">
        <p>‚Ä¢ Puedes <strong>cancelar tu suscripci√≥n en cualquier momento</strong>. La cancelaci√≥n se hace efectiva de inmediato y no se generar√°n cargos futuros.</p>
        <p>‚Ä¢ La suscripci√≥n se <strong>renueva autom√°ticamente cada 28 d√≠as</strong> a partir del momento de la compra, hasta que decidas cancelarla.</p>
        <p>‚Ä¢ <strong>No almacenamos datos personales</strong> m√°s all√° de la informaci√≥n estrictamente necesaria para procesar el pago. No vendemos ni compartimos informaci√≥n con terceros con fines comerciales.</p>
        <p>‚Ä¢ Este es un servicio experimental y sin prestaciones asociadas, ofrecido ‚Äútal cual‚Äù.</p>
      </div>
    </div>
  </div>

  <!-- CHECKOUT MODAL (mock de prueba) -->
  <div id="checkoutModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="coTitle">
    <div class="sheet">
      <button class="close-x" aria-label="Cerrar" id="coClose">√ó</button>
      <h2 id="coTitle">Elige tu m√©todo de pago</h2>
      <div class="pay-grid">
        <button class="pay-btn" id="payCard">Tarjeta de cr√©dito</button>
        <button class="pay-btn" id="payApple">Apple&nbsp;Pay</button>
        <button class="pay-btn" id="payPayPal">PayPal</button>
      </div>
      <p class="fine">Modo de prueba. Integraremos Stripe/Apple Pay/PayPal reales en producci√≥n.</p>
    </div>
  </div>

  <!-- AUTH MODAL (login / signup) -->
  <div id="authModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <div class="sheet">
      <button class="close-x" aria-label="Cerrar" id="authClose">√ó</button>
      <h2 id="authTitle">Iniciar sesi√≥n</h2>
      <div style="display:flex;flex-direction:column;gap:10px;margin-top:10px">
        <label style="text-align:left;font-size:14px">E-mail</label>
        <input id="authEmail" type="email" placeholder="tu@correo.com" style="padding:12px 14px;border:1px solid #111;border-radius:12px;font-size:15px" />
        <label style="text-align:left;font-size:14px">Contrase√±a (m√≠n. 6)</label>
        <input id="authPass" type="password" minlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="padding:12px 14px;border:1px solid #111;border-radius:12px;font-size:15px" />
        <div id="authError" class="fine" style="color:#dc2626;display:none">Datos ingresados incorrectos.</div>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:6px">
          <button id="authCancel" class="btn btn-white" style="background:#fff;color:#000;border:1px solid #000">Cancelar</button>
          <button id="authSubmit" class="btn btn-black">Continuar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  // Ejecuta TODO el JS una vez que el DOM est√© listo (evita null en elementos como #authClose)
  window.addEventListener('DOMContentLoaded', function(){
    (function(){
      // === CONSTANTES ===
      const MAX_NUMBER = 1000000; // 7 slots
      const MIN_NUMBER = 1;
      const SPIN_TIME = 1400; // ms base
      const COUNTDOWN_SECONDS = 45;

      // === ELEMENTOS ===
      const slotScreen = document.getElementById('slotScreen');
      const homeScreen = document.getElementById('homeScreen');
      const loserScreen = document.getElementById('loserScreen');
      const successScreen = document.getElementById('successScreen');
      const spinBtn = document.getElementById('spinBtn');
      const memberNumberEl = document.getElementById('memberNumber');
      const countdownEl = document.getElementById('countdown');
      const homeInner = document.getElementById('homeInner');
      const joinBtn = document.getElementById('joinBtn');
      const loseBtn = document.getElementById('loseBtn');
      const modal = document.getElementById('checkoutModal');
      const coClose = document.getElementById('coClose');
      const payCard = document.getElementById('payCard');
      const payApple = document.getElementById('payApple');
      const payPayPal = document.getElementById('payPayPal');
      // Auth elements
      const openLogin = document.getElementById('openLogin');
      const authModal = document.getElementById('authModal');
      const authClose = document.getElementById('authClose');
      const authTitle = document.getElementById('authTitle');
      const authEmail = document.getElementById('authEmail');
      const authPass = document.getElementById('authPass');
      const authError = document.getElementById('authError');
      const authCancel = document.getElementById('authCancel');
      const authSubmit = document.getElementById('authSubmit');
      const backToMenu = document.getElementById('backToMenu');
      const purchasedNumberEl = document.getElementById('purchasedNumber');
      const cancelSubBtn = document.getElementById('cancelSub');
      const termsLinkBtn = document.getElementById('termsLink');
      const termsModal = document.getElementById('termsModal');
      const termsClose = document.getElementById('termsClose');
      const confettiCanvas = document.getElementById('confetti');
      const confirmCancel = document.getElementById('confirmCancel');
      const confirmCancelClose = document.getElementById('confirmCancelClose');
      const confirmYes = document.getElementById('confirmYes');
      const confirmNo = document.getElementById('confirmNo');
      const postCancelInfo = document.getElementById('postCancelInfo');
      const releaseInfo = document.getElementById('releaseInfo');
      const releaseDateEl = document.getElementById('releaseDate');
      const renewSubBtn = document.getElementById('renewSub');
      const expireNotice = document.getElementById('expireNotice');
      const retryLink = document.getElementById('retryLink');
      const reels = Array.from(document.querySelectorAll('.digit-window'));

      // === ESTADO ===
      let reservedNumber = null;
      let countdownTimer = null;
      let remaining = COUNTDOWN_SECONDS;

      // === PERSISTENCIA DEMO ===
      const LS_KEY = 'purchasedNumbers_v1';
      const LS_USERS = 'users_v1';
      const LS_META = 'purchasedMeta_v1';
      const MS_28D = 28*24*60*60*1000;
      function loadPurchased(){
        try{
          const arr = JSON.parse(localStorage.getItem(LS_KEY)||'[]');
          return new Set(arr.filter(n=>Number.isInteger(n)&&n>=MIN_NUMBER&&n<=MAX_NUMBER));
        }catch(e){ return new Set(); }
      }
      function loadUsers(){ try{ return JSON.parse(localStorage.getItem(LS_USERS)||'{}'); }catch(e){ return {}; } }
      function saveUsers(users){ localStorage.setItem(LS_USERS, JSON.stringify(users)); }
      function savePurchased(set){ localStorage.setItem(LS_KEY, JSON.stringify(Array.from(set))); }
      function loadMeta(){ try{ return JSON.parse(localStorage.getItem(LS_META)||'{}'); } catch(e){ return {}; } }
      function saveMeta(meta){ localStorage.setItem(LS_META, JSON.stringify(meta)); }
      function markPurchased(n){
        const set = loadPurchased(); set.add(n); savePurchased(set);
        const meta = loadMeta(); meta[n]={status:'active', purchasedAt: Date.now(), nextRenewal: Date.now()+MS_28D}; saveMeta(meta);
      }
      function isPurchased(n){
        const meta = loadMeta();
        if(meta[n]){
          if(meta[n].status==='active') return true;
          if(meta[n].status==='cancelled') return Date.now() < (meta[n].nextRenewal||0);
        }
        return loadPurchased().has(n);
      }
      function pickAvailableNumber(){
        const set = loadPurchased();
        const meta = loadMeta();
        const unavailable=(n)=>{
          if(meta[n]){
            if(meta[n].status==='active') return true;
            if(meta[n].status==='cancelled') return Date.now() < (meta[n].nextRenewal||0);
          }
          return set.has(n);
        }
        if(set.size >= (MAX_NUMBER - MIN_NUMBER + 1)) return null; // agotado
        for(let i=0;i<5000;i++){
          const cand = randomInt(MIN_NUMBER, MAX_NUMBER);
          if(!unavailable(cand)) return cand;
        }
        for(let cand=MIN_NUMBER; cand<=MAX_NUMBER; cand++){
          if(!unavailable(cand)) return cand;
        }
        return null;
      }

      // === UTILIDADES ===
      function zeroPad(num){ return String(num).padStart(7,'0'); }
      function randomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

      // === ANIMACI√ìN TRAGAMONEDAS ===
      function animateReelsTo(targetStr){
        const endDigits = targetStr.split('').map(d=>parseInt(d,10));
        const easeOutCubic = (x)=>1-Math.pow(1-x,3);
        reels.forEach((el, idx)=>{
          const startDigit = (parseInt(el.textContent,10) || 0) % 10;
          const targetDigit = endDigits[idx];
          const fullTurns = 30 + idx*4; // vueltas visibles
          const totalSteps = fullTurns*10 + ((targetDigit - startDigit + 10) % 10);
          const duration = SPIN_TIME + idx*220 + 800; // cada carrete tarda m√°s
          const started = performance.now();

          const tick = (now)=>{
            const t = Math.min(1, (now - started)/duration);
            const eased = easeOutCubic(t);
            const step = Math.floor(eased * totalSteps);
            el.textContent = (startDigit + step) % 10;
            if (t < 1){
              requestAnimationFrame(tick);
            } else {
              el.textContent = targetDigit;
            }
          };
          requestAnimationFrame(tick);
        });
      }

      // === NAVEGACI√ìN ENTRE PANTALLAS ===
      function goHome(){
        slotScreen.classList.remove('active');
        loserScreen.classList.remove('active');
        homeScreen.classList.add('active');
        homeInner.classList.add('fade-enter','stagger');
        requestAnimationFrame(()=>{ homeInner.classList.add('fade-enter-active','stagger-on'); });
      }
      function goLoser(){
        clearInterval(countdownTimer);
        slotScreen.classList.remove('active');
        homeScreen.classList.remove('active');
        successScreen.classList.remove('active');
        loserScreen.classList.add('active');
      }
      function goSuccess(){
        slotScreen.classList.remove('active');
        homeScreen.classList.remove('active');
        loserScreen.classList.remove('active');
        successScreen.classList.add('active');
        startConfetti();
      }
      function goSlots(){
        clearInterval(countdownTimer);
        spinBtn.disabled = false;
        memberNumberEl.textContent = '‚Äî';
        countdownEl.textContent = COUNTDOWN_SECONDS;
        homeScreen.classList.remove('active');
        loserScreen.classList.remove('active');
        successScreen.classList.remove('active');
        slotScreen.classList.add('active');
      }

      // === CUENTA REGRESIVA ===
      function startCountdown(){
        clearInterval(countdownTimer);
        remaining = COUNTDOWN_SECONDS;
        countdownEl.textContent = remaining;
        joinBtn.disabled = false;
        countdownTimer = setInterval(()=>{
          remaining--; countdownEl.textContent = remaining;
          if(remaining<=0){
            clearInterval(countdownTimer);
            goSlots();
            showExpireNotice();
          }
        },1000);
      }

      // === L√ìGICA PRINCIPAL ===
      function assignNumber(){
        const next = pickAvailableNumber();
        if(next===null){
          alert('Todos los n√∫meros han sido adquiridos.');
          return;
        }
        reservedNumber = next;
        const formatted = zeroPad(reservedNumber);
        animateReelsTo(formatted);
        spinBtn.disabled = true;
        const lastReelDelay = SPIN_TIME + 6*220 + 800; // coincide con el √∫ltimo carrete
        setTimeout(()=>{
          memberNumberEl.textContent = formatted;
          goHome();
          startCountdown();
        }, lastReelDelay);
      }

      // === EVENTOS ===
      spinBtn.addEventListener('click', assignNumber);
      joinBtn.addEventListener('click', ()=>{ if(!joinBtn.disabled) openCheckout(); });
      loseBtn.addEventListener('click', ()=>{ goLoser(); });
      retryLink.addEventListener('click', ()=>{ goSlots(); });
      backToMenu.addEventListener('click', ()=>{ goSlots(); });
      cancelSubBtn.addEventListener('click', ()=>{ confirmCancel.classList.add('active'); });
      confirmCancelClose.addEventListener('click', ()=> confirmCancel.classList.remove('active'));
      confirmNo.addEventListener('click', ()=> confirmCancel.classList.remove('active'));
      confirmYes.addEventListener('click', ()=>{
        if(reservedNumber!=null){
          const meta = loadMeta();
          const cur = meta[reservedNumber] || { nextRenewal: Date.now()+MS_28D };
          meta[reservedNumber] = { ...cur, status:'cancelled', cancelledAt: Date.now(), nextRenewal: Math.max(cur.nextRenewal||0, Date.now()) };
          saveMeta(meta);
          // Mostrar fecha y controles
          const d = new Date(meta[reservedNumber].nextRenewal);
          releaseDateEl.textContent = d.toLocaleString();
          postCancelInfo.style.display = 'block';
          cancelSubBtn.disabled = true;
        }
        confirmCancel.classList.remove('active');
      });
      renewSubBtn.addEventListener('click', ()=>{
        if(reservedNumber!=null){
          const meta = loadMeta();
          meta[reservedNumber] = { status:'active', purchasedAt: Date.now(), nextRenewal: Date.now()+MS_28D };
          saveMeta(meta);
          postCancelInfo.style.display = 'none';
          cancelSubBtn.disabled = false;
        }
      });
      termsLinkBtn.addEventListener('click', ()=>{ termsModal.classList.add('active'); });
      termsClose.addEventListener('click', ()=> termsModal.classList.remove('active'));
      termsModal.addEventListener('click', (e)=>{ if(e.target===termsModal) termsModal.classList.remove('active'); });
      window.addEventListener('keydown', (e)=>{
        if(slotScreen.classList.contains('active') && !spinBtn.disabled && (e.key==='Enter' || e.key===' ')) assignNumber();
        if(e.key==='Escape' && modal.classList.contains('active')) closeCheckout();
        if(e.key==='Escape' && termsModal.classList.contains('active')) termsModal.classList.remove('active');
        if(e.key==='Escape' && authModal.classList.contains('active')) closeAuth();
      });

      // === CHECKOUT (DEMO) ===
      function openCheckout(){ modal.classList.add('active'); }
      function closeCheckout(){ modal.classList.remove('active'); }
      coClose.addEventListener('click', closeCheckout);
      modal.addEventListener('click', (e)=>{ if(e.target===modal) closeCheckout(); });
      const onPaid = (label)=>{
        if(reservedNumber!=null){ markPurchased(reservedNumber); }
        closeCheckout();
        openAuth('signup');
      };
      payCard.addEventListener('click', ()=> onPaid('tarjeta'));
      payApple.addEventListener('click', ()=> onPaid('Apple Pay'));
      payPayPal.addEventListener('click', ()=> onPaid('PayPal'));

      // === CONFETTI SIMPLE ===
      function startConfetti(durationMs=3500){
        const ctx = confettiCanvas.getContext('2d');
        const W = confettiCanvas.width = window.innerWidth;
        const H = confettiCanvas.height = window.innerHeight;
        const colors = ['#ff4d4f','#ffec3d','#40a9ff','#73d13d','#9254de','#fa8c16'];
        const N = Math.min(220, Math.floor(W/8));
        const parts = Array.from({length:N},()=>({
          x: Math.random()*W,
          y: -20 - Math.random()*H,
          r: 4+Math.random()*6,
          c: colors[(Math.random()*colors.length)|0],
          s: 2+Math.random()*3,
          a: Math.random()*Math.PI
        }));
        let start = performance.now();
        function frame(now){
          const t = now - start;
          const ctxW = confettiCanvas.width = window.innerWidth; // mantener tama√±o si cambia viewport
          const ctxH = confettiCanvas.height = window.innerHeight;
          ctx.clearRect(0,0,ctxW,ctxH);
          parts.forEach(p=>{ p.y += p.s; p.x += Math.sin((p.y+p.a)*0.02)*0.8; ctx.fillStyle=p.c; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); });
          if(t < durationMs){ requestAnimationFrame(frame); } else { ctx.clearRect(0,0,ctxW,ctxH); }
        }
        requestAnimationFrame(frame);
      }

      // === AUTENTICACI√ìN (login / signup) ===
      let authMode = 'login';
      let pendingMemberNumber = null;
      function openAuth(mode='login'){
        authMode = mode;
        authTitle.textContent = mode==='login' ? 'Iniciar sesi√≥n' : 'Crear cuenta';
        authError.style.display = 'none';
        authEmail.value = '';
        authPass.value = '';
        authModal.classList.add('active');
        if(mode==='signup') pendingMemberNumber = reservedNumber;
      }
      function closeAuth(){ authModal.classList.remove('active'); }
      function emailValid(e){ return /.+@.+\..+/.test(e); }
      if(openLogin){ openLogin.addEventListener('click', ()=> openAuth('login')); }
      if(authClose){ authClose.addEventListener('click', closeAuth); }
      if(authCancel){ authCancel.addEventListener('click', closeAuth); }
      if(authSubmit){
        authSubmit.addEventListener('click', ()=>{
          const email = authEmail.value.trim();
          const pass = authPass.value;
          if(!emailValid(email) || pass.length < 6){ authError.style.display='block'; return; }
          const users = loadUsers();
          if(authMode==='login'){
          const u = users[email];
          if(!u || u.pass !== pass){ authError.style.display='block'; return; }
          // Debe existir membres√≠a activa asociada
          const number = u.memberNumber;
          if(!number){ authError.style.display='block'; return; }
          reservedNumber = number;
          memberNumberEl.textContent = zeroPad(reservedNumber);
          if (typeof purchasedNumberEl !== 'undefined' && purchasedNumberEl) {
            purchasedNumberEl.textContent = zeroPad(reservedNumber);
          }
          closeAuth();
          goSuccess();
        } else {
          // signup tras compra
          if(!pendingMemberNumber){ authError.style.display='block'; return; }
          users[email] = { pass, memberNumber: pendingMemberNumber, status:'active' };
          saveUsers(users);
          reservedNumber = pendingMemberNumber;
          memberNumberEl.textContent = zeroPad(reservedNumber);
          if (typeof purchasedNumberEl !== 'undefined' && purchasedNumberEl) {
            purchasedNumberEl.textContent = zeroPad(reservedNumber);
          }
          closeAuth();
          goSuccess();
        }
      });
      }

      // === AVISO DE EXPIRACI√ìN ===
      function showExpireNotice(){
        if(!expireNotice) return;
        if(showExpireNotice._shown) return; // evitar duplicados
        showExpireNotice._shown = true;
        expireNotice.style.display = 'inline-flex';
        setTimeout(()=>{ expireNotice.style.display = 'none'; showExpireNotice._shown = false; }, 4000);
      }

      // ==================
      // PRUEBAS R√ÅPIDAS (self-tests)
      // ==================
      (function runSelfTests(){
        const tests = [];
        const assert = (name, cond) => tests.push({name, pass: !!cond});
        tests.push({name:'Funci√≥n animateReelsTo existe', pass: typeof animateReelsTo === 'function'});

        assert('T√≠tulo tragamonedas correcto', document.getElementById('slotTitle').textContent.trim()==='Tu n√∫mero de miembro');
        assert('Hay 7 d√≠gitos en el tragamonedas', document.querySelectorAll('.digit-window').length === 7);
        assert('Rango m√≠nimo 1', MIN_NUMBER === 1);
        assert('Rango m√°ximo 1,000,000', MAX_NUMBER === 1000000);
        assert('Countdown inicial 45', parseInt(document.getElementById('countdown').textContent,10) === 45);
        assert('Bot√≥n unirme existe', !!document.getElementById('joinBtn'));
        assert('Bot√≥n perdedor existe', !!document.getElementById('loseBtn'));
        assert('Modal de checkout existe', !!document.getElementById('checkoutModal'));
        assert('Pantalla de √©xito existe', !!document.getElementById('successScreen'));
        assert('Canvas de confeti existe', !!document.getElementById('confetti'));
        assert('Bot√≥n cancelar subscripci√≥n existe', !!document.getElementById('cancelSub'));
        assert('Bot√≥n t√©rminos existe', !!document.getElementById('termsLink'));
        assert('Modal confirm cancel existe', !!document.getElementById('confirmCancel'));
        assert('Bot√≥n renovar existe', !!document.getElementById('renewSub'));
        assert('Aviso de expiraci√≥n existe', !!document.getElementById('expireNotice'));
        assert('Link Obtener nuevo n√∫mero existe', !!document.getElementById('retryLink'));
        assert('Link Iniciar sesi√≥n existe', !!document.getElementById('openLogin'));
        assert('Modal auth existe', !!document.getElementById('authModal'));
        assert('Campo email existe', !!document.getElementById('authEmail'));
        assert('Campo password existe', !!document.getElementById('authPass'));
        assert('Pantalla perdedor existe', !!document.getElementById('loserScreen'));
        assert('Bot√≥n volver del perdedor existe', !!document.getElementById('backToMenu'));
        // Unicidad de IDs
        assert('ID √∫nico #countdown', document.querySelectorAll('#countdown').length === 1);
        assert('ID √∫nico #memberNumber', document.querySelectorAll('#memberNumber').length === 1);
        assert('ID √∫nico #joinBtn', document.querySelectorAll('#joinBtn').length === 1);
        assert('ID √∫nico #loseBtn', document.querySelectorAll('#loseBtn').length === 1);
        assert('ID √∫nico #purchasedNumber', document.querySelectorAll('#purchasedNumber').length === 1);
        // Formato de n√∫mero reservado (si existe)
        const nn = document.getElementById('memberNumber').textContent.trim();
        assert('Placeholder de n√∫mero correcto', nn==='‚Äî' || /^\d{7}$/.test(nn));

        const passed = tests.filter(t=>t.pass).length;
        console.log(`[SELF-TEST] ${passed}/${tests.length} pruebas OK`, tests);
      })();

    })();
  });
  </script>
</body>
</html>
