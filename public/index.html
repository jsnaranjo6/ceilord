<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>$1 al mes ‚Äì Nada a cambio</title>
  <meta name="description" content="Paga $1 al mes y recibe absolutamente nada. Limitado a 1 mill√≥n de miembros." />
  <style>
    :root{
      --bg:#ffffff;
      --fg:#000000;
      --muted:#6b7280;
      --accent:#16a34a;
      --border:#e5e7eb;
      --alert:#dc2626;
      --stack-gap: clamp(16px, 3.2vw, 28px);
    }

    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
      font-family: Helvetica, Arial, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Liberation Sans", sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    *{box-sizing:border-box}

    .screen{display:none;min-height:100dvh;padding:clamp(16px,4vw,40px)}
    .screen.active{display:flex;align-items:center;justify-content:center}

    .slot-wrap{width:min(1000px,92vw);display:flex;flex-direction:column;align-items:center;gap:clamp(16px,2.5vw,28px);text-align:center}
    .brand{font-weight:600;letter-spacing:.02em}
    .slots{display:grid;grid-template-columns:repeat(7,1fr);gap:clamp(6px,1.2vw,12px);width:100%;max-width:980px}
    .reel{position:relative;background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06);aspect-ratio:1/1.4;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .digit-window{font-variant-numeric:tabular-nums;font-feature-settings:"tnum" 1, "ss01" 1;font-size:clamp(48px,9vw,120px);line-height:1;font-weight:700}
    .slot-cta{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center}
    .btn{appearance:none;border:1px solid var(--fg);background:#000;color:#fff;padding:14px 20px;border-radius:999px;font-weight:600;cursor:pointer;transition:transform .06s ease,opacity .2s ease;letter-spacing:.01em}
    .btn:disabled{opacity:.4;cursor:not-allowed}
    .retry{margin-top:var(--stack-gap);}
    .linklike{appearance:none;background:transparent;border:none;padding:6px 10px;border-radius:999px;color:#111;font-weight:600;text-decoration:underline;cursor:pointer}
    .linklike:hover{opacity:.8}

    .home-wrap{width:100%;max-width:min(860px,92vw);display:flex;flex-direction:column;gap:var(--stack-gap);align-items:center;text-align:center;justify-content:center;margin-left:auto;margin-right:auto}
    h1{margin:0;line-height:1.1;font-weight:700;font-size:clamp(28px,4.5vw,56px)}
    .sub{color:var(--muted);font-size:clamp(16px,2.2vw,20px)}
    .reservation{display:flex;flex-direction:column;gap:8px;align-items:center;padding:0;border:none;box-shadow:none;width:auto;max-width:none;background:transparent}
    .tag{display:inline-flex;align-items:center;gap:10px;font-variant-numeric:tabular-nums;font-weight:700;letter-spacing:.02em;padding:8px 14px;border-radius:999px;border:1px solid var(--border)}
    .countdown{font-weight:700}
    .actions{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
    .btn-black{background:#000;color:#fff}
    .btn-white{background:#fff;color:#000;border:1px solid var(--fg)}
    .checks{display:grid;grid-template-columns:1fr;gap:var(--stack-gap);width:100%;max-width:560px;justify-items:center;text-align:left}
    .check{display:flex;align-items:center;gap:10px;justify-content:flex-start;width:100%;max-width:560px}
    .check svg{flex:0 0 auto}
    .home-fold{min-height:100dvh;display:flex;align-items:center;justify-content:center;width:100%}
    .home-stack> * + *{margin-top:var(--stack-gap)}
    .home-stack{display:flex;flex-direction:column;align-items:center;padding-block:var(--stack-gap)}

    .fade-enter{opacity:0;transform:translateY(10px)}
    .fade-enter-active{opacity:1;transform:none;transition:all .5s ease}

    @keyframes fadeUp { from { opacity:0; transform: translateY(8px); } to { opacity:1; transform:none; } }
    .stagger > *{opacity:0; transform: translateY(8px)}
    .stagger-on > *{animation: fadeUp .6s ease forwards}
    .stagger-on > *:nth-child(1){animation-delay:.00s}
    .stagger-on > *:nth-child(2){animation-delay:.08s}
    .stagger-on > *:nth-child(3){animation-delay:.16s}
    .stagger-on > *:nth-child(4){animation-delay:.24s}
    .stagger-on .home-stack > *{opacity:0;animation: fadeUp .6s ease forwards}
    .stagger-on .home-stack > *:nth-child(1){animation-delay:.20s}
    .stagger-on .home-stack > *:nth-child(2){animation-delay:.32s}
    .stagger-on .home-stack > *:nth-child(3){animation-delay:.44s}

    .notice{position:fixed;top:12px;left:50%;transform:translateX(-50%);padding:10px 16px;border-radius:999px;border:1px solid rgba(220,38,38,.25);background:rgba(220,38,38,.08);color:var(--alert);font-weight:600;display:none;z-index:50}

    .loser-wrap{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px;background:#fff}
    .emoji-box{position:relative;display:inline-flex;align-items:center;justify-content:center}
    .emoji{font-size:clamp(160px,32vw,360px);display:inline-block;animation: headTilt 2.2s ease-in-out infinite, scalePulse 2.2s ease-in-out infinite}
    .back-link{appearance:none;background:transparent;border:1px solid #111;color:#111;padding:10px 14px;border-radius:999px;font-weight:600;cursor:pointer}

    @keyframes headTilt{ 0%,100%{ transform: rotate(0deg)} 25%{ transform: rotate(3deg)} 50%{ transform: rotate(0deg)} 75%{ transform: rotate(-3deg)} }
    @keyframes scalePulse{ 0%,100%{ transform: scale(1)} 50%{ transform: scale(1.06)} }

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55)}
    .modal.active{display:flex}
    .sheet{background:#fff;color:#000;width:min(520px,92vw);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.25);padding:24px;position:relative}
    .sheet h2{margin:0 0 12px 0;font-size:22px}
    .pay-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    .pay-btn{display:flex;align-items:center;justify-content:center;gap:10px;border:1px solid #111;border-radius:999px;padding:12px 16px;font-weight:600;cursor:pointer;background:#fff}
    .close-x{position:absolute;right:16px;top:12px;background:transparent;border:none;font-size:24px;cursor:pointer}
    .fine{color:#6b7280;font-size:13px;margin-top:12px}
    input:focus{outline:none;box-shadow:0 0 0 3px rgba(0,0,0,.08)}

    .app-header{position:fixed;top:14px;left:14px;z-index:100;display:flex;align-items:center;gap:10px}
    .site-logo-text{
      font-family: Helvetica, Arial, sans-serif;
      font-weight: 700;
      font-size: clamp(28px, 3vw, 40px);
      color:#111;
      letter-spacing:0;
      user-select:none;
    }
  </style>
</head>
<body>
  <header class="app-header" role="banner">
    <div class="site-logo-text">CEILORD</div>
  </header>
  <button id="expireNotice" class="notice" role="alert">El tiempo se agot√≥, vuelve a intentarlo</button>

  <!-- SLOT MACHINE SCREEN -->
  <section id="slotScreen" class="screen active">
    <div class="slot-wrap">
      <div class="brand">&nbsp;</div>
      <h1>Tu n√∫mero de miembro</h1>
      <p class="fine" style="text-align:center;margin:-6px 0 4px;">Beneficios exclusivos pr√≥ximamente</p>
      <div class="slots">
        <div class="reel"><div class="digit-window" data-reel="0">0</div></div>
        <div class="reel"><div class="digit-window" data-reel="1">0</div></div>
        <div class="reel"><div class="digit-window" data-reel="2">0</div></div>
        <div class="reel"><div class="digit-window" data-reel="3">0</div></div>
        <div class="reel"><div class="digit-window" data-reel="4">0</div></div>
        <div class="reel"><div class="digit-window" data-reel="5">0</div></div>
        <div class="reel"><div class="digit-window" data-reel="6">0</div></div>
      </div>
      <div class="slot-cta">
        <button id="spinBtn" class="btn">Obtener mi n√∫mero</button>
      </div>
      <p style="margin:6px 0 0 0;font-size:14px;color:#111;">
        <button id="openLogin" class="linklike">Iniciar sesi√≥n</button>
      </p>
    </div>
  </section>

  <!-- HOME SCREEN -->
  <main id="homeScreen" class="screen">
    <div class="home-wrap home-fold">
      <div class="fade-enter stagger" id="homeInner">
        <h1>Paga $1 al mes y recibe absolutamente nada.</h1>
        <p class="sub">Limitado a solo 1 mill√≥n de miembros.</p>
        <div class="home-stack">
          <div class="reservation">
            <div class="tag" id="memberTag">N¬∫ <span id="memberNumber">‚Äî</span> ¬∑ <span>Reservado</span></div>
            <div class="countdown">Expira en <span id="countdown">45</span>s</div>
          </div>
          <div class="actions">
            <button id="joinBtn" class="btn btn-black">Quiero unirme, soy incre√≠ble</button>
            <button id="loseBtn" class="btn btn-white">Soy un perdedor</button>
          </div>
          <div class="checks">
            <div class="check">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M20 6L9 17l-5-5" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              <span>Cancela en cualquier momento</span>
            </div>
            <div class="check">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M20 6L9 17l-5-5" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              <span>1 dollar al mes</span>
            </div>
            <div class="check">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M20 6L9 17l-5-5" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              <span>S√© parte del 0,012% del planeta</span>
            </div>
          </div>
          <p class="retry"><button id="retryLink" class="linklike">Obtener nuevo n√∫mero</button></p>
        </div>
      </div>
    </div>
  </main>

  <!-- LOSER SCREEN -->
  <section id="loserScreen" class="screen">
    <div class="loser-wrap">
      <div class="emoji-box"><span class="emoji">üòÇ</span></div>
      <button id="backToMenu" class="back-link">Regresar al men√∫ principal</button>
    </div>
  </section>

  <!-- SUCCESS SCREEN -->
  <section id="successScreen" class="screen">
    <canvas id="confetti" style="position:fixed;inset:0;pointer-events:none"></canvas>
    <div class="home-wrap" style="gap:24px; text-align:center;">
      <h1>¬°Bienvenido!</h1>
      <p class="sub">Tu n√∫mero de miembro</p>
      <div style="font-variant-numeric:tabular-nums;font-weight:800;font-size:clamp(40px,7vw,84px);">N¬∫ <span id="purchasedNumber">‚Äî</span></div>
      <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
        <button id="cancelSub" class="btn btn-white" style="border:1px solid #000;color:#000;background:#fff">Cancelar suscripci√≥n</button>
        <button id="termsLink" class="btn btn-black" style="background:#000;color:#fff">T√©rminos y condiciones</button>
      </div>
      <p class="fine" style="margin-top:10px;">Los fondos recaudados ser√°n utilizados en beneficencia del pueblo ecuatoriano.</p>
      <div id="postCancelInfo" style="display:none; margin-top:12px">
        <p class="sub">Tu n√∫mero se liberar√° el <span id="releaseDate">‚Äî</span>.</p>
        <button id="renewSub" class="btn btn-black">Renovar la suscripci√≥n</button>
      </div>
    </div>
  </section>

  <!-- CONFIRM CANCEL MODAL -->
  <div id="confirmCancel" class="modal" role="dialog">
    <div class="sheet">
      <button class="close-x" id="confirmCancelClose">√ó</button>
      <h2>¬øCancelar suscripci√≥n?</h2>
      <p class="fine" style="font-size:14px;line-height:1.6">
        ¬øEst√°s seguro que deseas cancelar la suscripci√≥n? <strong>Tu n√∫mero de miembro volver√° a estar disponible</strong>
        cuando finalice tu ciclo actual de 28 d√≠as.
      </p>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
        <button id="confirmNo" class="btn btn-white" style="background:#fff;color:#000;border:1px solid #000">No</button>
        <button id="confirmYes" class="btn btn-black">S√≠</button>
      </div>
    </div>
  </div>

  <!-- TERMS MODAL -->
  <div id="termsModal" class="modal" role="dialog">
    <div class="sheet">
      <button class="close-x" id="termsClose">√ó</button>
      <h2>T√©rminos y condiciones</h2>
      <div class="fine" style="font-size:14px;line-height:1.6">
        <p>‚Ä¢ Puedes <strong>cancelar tu suscripci√≥n en cualquier momento</strong>.</p>
        <p>‚Ä¢ La suscripci√≥n se <strong>renueva autom√°ticamente cada 28 d√≠as</strong>.</p>
        <p>‚Ä¢ <strong>No almacenamos datos personales</strong> m√°s all√° de lo necesario para procesar el pago.</p>
        <p>‚Ä¢ Este es un servicio experimental y sin prestaciones asociadas.</p>
      </div>
    </div>
  </div>

  <!-- CHECKOUT MODAL -->
  <div id="checkoutModal" class="modal" role="dialog">
    <div class="sheet">
      <button class="close-x" id="coClose">√ó</button>
      <h2>Elige tu m√©todo de pago</h2>
      <div class="pay-grid">
        <button id="payCard" class="pay-btn">Tarjeta de cr√©dito</button>
        <button id="payPayPal" class="pay-btn">PayPal</button>
      </div>
      <p class="fine">$1 USD al mes. Cancela cuando quieras.</p>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div id="authModal" class="modal" role="dialog">
    <div class="sheet">
      <button class="close-x" id="authClose">√ó</button>
      <h2 id="authTitle">Iniciar sesi√≥n</h2>
      <div style="display:flex;flex-direction:column;gap:10px;margin-top:10px">
        <label style="text-align:left;font-size:14px">E-mail</label>
        <input id="authEmail" type="email" placeholder="tu@correo.com" style="padding:12px 14px;border:1px solid #111;border-radius:12px;font-size:15px" />
        <label style="text-align:left;font-size:14px">Contrase√±a (m√≠n. 6)</label>
        <input id="authPass" type="password" minlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="padding:12px 14px;border:1px solid #111;border-radius:12px;font-size:15px" />
        <div id="authError" class="fine" style="color:#dc2626;display:none">Datos ingresados incorrectos.</div>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:6px">
          <button id="authCancel" class="btn btn-white" style="background:#fff;color:#000;border:1px solid #000">Cancelar</button>
          <button id="authSubmit" class="btn btn-black">Aceptar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const PAYMENT_LINKS = {
      card: 'https://ppls.me/5NTwxIdRRNa6bEODJ4WOhw',
      paypal: 'https://www.paypal.com/ncp/payment/F5FAB56A8H5EC'
    };

    const MAX_NUMBER = 1000000;
    const MIN_NUMBER = 1;
    const SPIN_TIME = 1400;
    const COUNTDOWN_SECONDS = 45;
    const LS_KEY = 'purchasedNumbers_v1';
    const LS_USERS = 'users_v1';
    const LS_META = 'purchasedMeta_v1';
    const MS_28D = 28*24*60*60*1000;

    const zeroPad = (num) => String(num).padStart(7,'0');
    const randomInt = (min,max) => Math.floor(Math.random()*(max-min+1))+min;

    const state = {
      reservedNumber: null,
      countdownTimer: null,
      remaining: COUNTDOWN_SECONDS,
      authMode: 'login',
      pendingMemberNumber: null,
    };

    const els = {
      slotScreen: document.getElementById('slotScreen'),
      homeScreen: document.getElementById('homeScreen'),
      loserScreen: document.getElementById('loserScreen'),
      successScreen: document.getElementById('successScreen'),
      spinBtn: document.getElementById('spinBtn'),
      memberNumberEl: document.getElementById('memberNumber'),
      countdownEl: document.getElementById('countdown'),
      homeInner: document.getElementById('homeInner'),
      joinBtn: document.getElementById('joinBtn'),
      loseBtn: document.getElementById('loseBtn'),
      modal: document.getElementById('checkoutModal'),
      coClose: document.getElementById('coClose'),
      payCard: document.getElementById('payCard'),
      payPayPal: document.getElementById('payPayPal'),
      openLogin: document.getElementById('openLogin'),
      authModal: document.getElementById('authModal'),
      authClose: document.getElementById('authClose'),
      authTitle: document.getElementById('authTitle'),
      authEmail: document.getElementById('authEmail'),
      authPass: document.getElementById('authPass'),
      authError: document.getElementById('authError'),
      authCancel: document.getElementById('authCancel'),
      authSubmit: document.getElementById('authSubmit'),
      backToMenu: document.getElementById('backToMenu'),
      purchasedNumberEl: document.getElementById('purchasedNumber'),
      cancelSubBtn: document.getElementById('cancelSub'),
      termsLinkBtn: document.getElementById('termsLink'),
      termsModal: document.getElementById('termsModal'),
      termsClose: document.getElementById('termsClose'),
      confettiCanvas: document.getElementById('confetti'),
      confirmCancel: document.getElementById('confirmCancel'),
      confirmCancelClose: document.getElementById('confirmCancelClose'),
      confirmYes: document.getElementById('confirmYes'),
      confirmNo: document.getElementById('confirmNo'),
      postCancelInfo: document.getElementById('postCancelInfo'),
      releaseDateEl: document.getElementById('releaseDate'),
      renewSubBtn: document.getElementById('renewSub'),
      expireNotice: document.getElementById('expireNotice'),
      retryLink: document.getElementById('retryLink'),
      reels: Array.from(document.querySelectorAll('.digit-window')),
    };

    function loadPurchased(){
      try{
        const arr = JSON.parse(localStorage.getItem(LS_KEY)||'[]');
        return new Set(arr.filter(n=>Number.isInteger(n)&&n>=MIN_NUMBER&&n<=MAX_NUMBER));
      }catch(e){ return new Set(); }
    }
    function loadUsers(){ try{ return JSON.parse(localStorage.getItem(LS_USERS)||'{}'); }catch(e){ return {}; } }
    function saveUsers(users){ localStorage.setItem(LS_USERS, JSON.stringify(users)); }
    function savePurchased(set){ localStorage.setItem(LS_KEY, JSON.stringify(Array.from(set))); }
    function loadMeta(){ try{ return JSON.parse(localStorage.getItem(LS_META)||'{}'); } catch(e){ return {}; } }
    function saveMeta(meta){ localStorage.setItem(LS_META, JSON.stringify(meta)); }

    function markPurchased(n){
      const set = loadPurchased(); set.add(n); savePurchased(set);
      const meta = loadMeta(); meta[n] = { status:'active', purchasedAt: Date.now(), nextRenewal: Date.now()+MS_28D }; saveMeta(meta);
    }

    function animateReelsTo(targetStr){
      const endDigits = targetStr.split('').map(d=>parseInt(d,10));
      const easeOutCubic = (x)=>1-Math.pow(1-x,3);
      els.reels.forEach((el, idx)=>{
        const startDigit = (parseInt(el.textContent,10) || 0) % 10;
        const targetDigit = endDigits[idx];
        const fullTurns = 30 + idx*4;
        const totalSteps = fullTurns*10 + ((targetDigit - startDigit + 10) % 10);
        const duration = SPIN_TIME + idx*220 + 800;
        const started = performance.now();

        const tick = (now)=>{
          const t = Math.min(1, (now - started)/duration);
          const eased = easeOutCubic(t);
          const step = Math.floor(eased * totalSteps);
          el.textContent = (startDigit + step) % 10;
          if (t < 1) requestAnimationFrame(tick);
          else el.textContent = targetDigit;
        };
        requestAnimationFrame(tick);
      });
    }

    function goHome(){
      els.slotScreen.classList.remove('active');
      els.loserScreen.classList.remove('active');
      els.homeScreen.classList.add('active');
      els.homeInner.classList.add('fade-enter','stagger');
      requestAnimationFrame(()=>{ els.homeInner.classList.add('fade-enter-active','stagger-on'); });
    }
    function goLoser(){
      clearInterval(state.countdownTimer);
      els.slotScreen.classList.remove('active');
      els.homeScreen.classList.remove('active');
      els.successScreen.classList.remove('active');
      els.loserScreen.classList.add('active');
    }
    function goSuccess(){
      els.slotScreen.classList.remove('active');
      els.homeScreen.classList.remove('active');
      els.loserScreen.classList.remove('active');
      els.successScreen.classList.add('active');
      startConfetti();
    }
    function goSlots(){
      clearInterval(state.countdownTimer);
      els.spinBtn.disabled = false;
      els.memberNumberEl.textContent = '‚Äî';
      els.countdownEl.textContent = '45';
      els.homeScreen.classList.remove('active');
      els.loserScreen.classList.remove('active');
      els.successScreen.classList.remove('active');
      els.slotScreen.classList.add('active');
    }

    function startCountdown() {
      clearInterval(state.countdownTimer);
      state.remaining = COUNTDOWN_SECONDS;
      els.countdownEl.textContent = state.remaining;
      if (els.joinBtn) els.joinBtn.disabled = false;
      state.countdownTimer = setInterval(()=>{
        state.remaining -= 1;
        els.countdownEl.textContent = state.remaining;
        if(state.remaining <= 0){
          clearInterval(state.countdownTimer);
          state.countdownTimer = null;
          goSlots();
          showExpireNotice();
        }
      }, 1000);
    }

    function showExpireNotice(){
      if(!els.expireNotice) return;
      if(showExpireNotice._shown) return;
      showExpireNotice._shown = true;
      els.expireNotice.style.display = 'inline-flex';
      setTimeout(()=>{ els.expireNotice.style.display = 'none'; showExpireNotice._shown = false; }, 4000);
    }

    function startConfetti(durationMs=3500){
      const ctx = els.confettiCanvas.getContext('2d');
      let W = els.confettiCanvas.width = window.innerWidth;
      let H = els.confettiCanvas.height = window.innerHeight;
      const colors = ['#ff4d4f','#ffec3d','#40a9ff','#73d13d','#9254de','#fa8c16'];
      const N = Math.min(220, Math.floor(W/8));
      const parts = Array.from({length:N},()=>({
        x: Math.random()*W,
        y: -20 - Math.random()*H,
        r: 4+Math.random()*6,
        c: colors[(Math.random()*colors.length)|0],
        s: 2+Math.random()*3,
        a: Math.random()*Math.PI
      }));
      let start = performance.now();

      function handleResize(){
        W = els.confettiCanvas.width = window.innerWidth;
        H = els.confettiCanvas.height = window.innerHeight;
      }
      const onResize = ()=> handleResize();
      window.addEventListener('resize', onResize);

      function frame(now){
        const t = now - start;
        ctx.clearRect(0,0,W,H);
        parts.forEach(p=>{
          p.y += p.s; p.x += Math.sin((p.y+p.a)*0.02)*0.8;
          ctx.fillStyle=p.c; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
        });
        if(t < durationMs) requestAnimationFrame(frame);
        else { ctx.clearRect(0,0,W,H); window.removeEventListener('resize', onResize); }
      }
      requestAnimationFrame(frame);
    }

    function pickAvailableNumber(){
      const set = loadPurchased();
      const meta = loadMeta();
      const unavailable=(n)=>{
        if(meta[n]){
          if(meta[n].status==='active') return true;
          if(meta[n].status==='cancelled') return Date.now() < (meta[n].nextRenewal||0);
        }
        return set.has(n);
      };
      if(set.size >= (MAX_NUMBER - MIN_NUMBER + 1)) return null;
      for(let i=0;i<5000;i++){
        const cand = randomInt(MIN_NUMBER, MAX_NUMBER);
        if(!unavailable(cand)) return cand;
      }
      for(let cand=MIN_NUMBER; cand<=MAX_NUMBER; cand++){
        if(!unavailable(cand)) return cand;
      }
      return null;
    }

    function assignNumber(){
      const next = pickAvailableNumber();
      if(next===null){
        alert('Todos los n√∫meros han sido adquiridos.');
        return;
      }
      state.reservedNumber = next;
      const formatted = zeroPad(state.reservedNumber);
      animateReelsTo(formatted);
      els.spinBtn.disabled = true;
      const lastReelDelay = SPIN_TIME + 6*220 + 800;
      setTimeout(()=>{
        els.memberNumberEl.textContent = formatted;
        goHome();
        startCountdown();
      }, lastReelDelay);
    }

    function openCheckout(){
      if(els.modal) els.modal.classList.add('active');
    }
    function closeCheckout(){
      if(els.modal) els.modal.classList.remove('active');
    }

    function openAuth(mode='login'){
      state.authMode = mode;
      els.authTitle.textContent = mode==='login' ? 'Iniciar sesi√≥n' : 'Crear cuenta';
      els.authError.style.display = 'none';
      els.authEmail.value = '';
      els.authPass.value = '';
      els.authModal.classList.add('active');
      if(mode==='signup') state.pendingMemberNumber = state.reservedNumber;
    }
    function closeAuth(){ els.authModal.classList.remove('active'); }
    const emailValid = (e)=> /.+@.+\..+/.test(e);

    function wireUI(){
      els.spinBtn.addEventListener('click', assignNumber);
      els.joinBtn.addEventListener('click', ()=>{ if(!els.joinBtn.disabled) openCheckout(); });
      els.loseBtn.addEventListener('click', ()=>{ goLoser(); });
      els.retryLink.addEventListener('click', ()=>{ goSlots(); });
      els.backToMenu.addEventListener('click', ()=>{ goSlots(); });

      els.coClose.addEventListener('click', closeCheckout);
      els.modal.addEventListener('click', (e)=>{ if(e.target === els.modal) closeCheckout(); });

      document.addEventListener('click', (e)=>{
        const btnCard = e.target.closest('#payCard');
        const btnPayPal = e.target.closest('#payPayPal');
        if(btnCard){
          e.preventDefault();
          const member = state.reservedNumber != null ? zeroPad(state.reservedNumber) : '';
          const url = PAYMENT_LINKS.card.replace(/\{MEMBER\}/g, member);
          if(url) window.location.assign(url);
          return;
        }
        if(btnPayPal){
          e.preventDefault();
          const member = state.reservedNumber != null ? zeroPad(state.reservedNumber) : '';
          const url = PAYMENT_LINKS.paypal.replace(/\{MEMBER\}/g, member);
          if(url) window.location.assign(url);
          return;
        }
      });

      els.openLogin?.addEventListener('click', ()=> openAuth('login'));
      els.authClose?.addEventListener('click', closeAuth);
      els.authCancel?.addEventListener('click', closeAuth);

      els.authSubmit?.addEventListener('click', ()=>{
        const email = els.authEmail.value.trim();
        const pass = els.authPass.value;
        if(!emailValid(email) || pass.length < 6){ els.authError.style.display='block'; return; }
        const users = loadUsers();

        if(state.authMode==='login'){
          const u = users[email];
          if(!u || u.pass !== pass){ els.authError.style.display='block'; return; }
          const number = u.memberNumber;
          if(!number){ els.authError.style.display='block'; return; }
          state.reservedNumber = number;
          els.memberNumberEl.textContent = zeroPad(state.reservedNumber);
          if(els.purchasedNumberEl) els.purchasedNumberEl.textContent = zeroPad(state.reservedNumber);
          closeAuth();
          goSuccess();
        } else {
          if(!state.pendingMemberNumber){ els.authError.style.display='block'; return; }
          users[email] = { pass, memberNumber: state.pendingMemberNumber, status:'active' };
          saveUsers(users);
          state.reservedNumber = state.pendingMemberNumber;
          els.memberNumberEl.textContent = zeroPad(state.reservedNumber);
          if(els.purchasedNumberEl) els.purchasedNumberEl.textContent = zeroPad(state.reservedNumber);
          closeAuth();
          goSuccess();
        }
      });

      els.cancelSubBtn.addEventListener('click', ()=>{ els.confirmCancel.classList.add('active'); });
      els.confirmCancelClose.addEventListener('click', ()=> els.confirmCancel.classList.remove('active'));
      els.confirmNo.addEventListener('click', ()=> els.confirmCancel.classList.remove('active'));
      els.confirmYes.addEventListener('click', ()=>{
        if(state.reservedNumber!=null){
          const meta = loadMeta();
          const cur = meta[state.reservedNumber] || { nextRenewal: Date.now()+MS_28D };
          meta[state.reservedNumber] = { ...cur, status:'cancelled', cancelledAt: Date.now(), nextRenewal: Math.max(cur.nextRenewal||0, Date.now()) };
          saveMeta(meta);
          const d = new Date(meta[state.reservedNumber].nextRenewal);
          els.releaseDateEl.textContent = d.toLocaleString();
          els.postCancelInfo.style.display = 'block';
          els.cancelSubBtn.disabled = true;
        }
        els.confirmCancel.classList.remove('active');
      });
      els.renewSubBtn.addEventListener('click', ()=>{
        if(state.reservedNumber!=null){
          const meta = loadMeta();
          meta[state.reservedNumber] = { status:'active', purchasedAt: Date.now(), nextRenewal: Date.now()+MS_28D };
          saveMeta(meta);
          els.postCancelInfo.style.display = 'none';
          els.cancelSubBtn.disabled = false;
        }
      });

      els.termsLinkBtn.addEventListener('click', ()=>{ els.termsModal.classList.add('active'); });
      els.termsClose.addEventListener('click', ()=> els.termsModal.classList.remove('active'));
      els.termsModal.addEventListener('click', (e)=>{ if(e.target===els.termsModal) els.termsModal.classList.remove('active'); });

      window.addEventListener('keydown', (e)=>{
        if(els.slotScreen.classList.contains('active') && !els.spinBtn.disabled && (e.key==='Enter' || e.key===' ')) assignNumber();
        if(e.key==='Escape' && els.modal.classList.contains('active')) closeCheckout();
        if(e.key==='Escape' && els.termsModal.classList.contains('active')) els.termsModal.classList.remove('active');
        if(e.key==='Escape' && els.authModal.classList.contains('active')) closeAuth();
      });
    }

    window.addEventListener('DOMContentLoaded', wireUI);
  </script>
</body>
</html>
